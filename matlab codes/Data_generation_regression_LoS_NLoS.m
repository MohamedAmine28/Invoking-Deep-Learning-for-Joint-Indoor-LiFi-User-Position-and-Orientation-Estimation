N_r = 16;
N = 10^6;
Psi_Fov = 90*pi/180;
Phi_Fov = 90*pi/180;
%-------------------------------------------------------------------------%
L = 2.5; 
W = 2.5; 
ha = 3; 
h_device = 1.5;
%-------------------------------------------------------------------------%
Phi1_2 = 60*pi/180; 
NLEDs = 1;
rho = 0.7;
nc = 1; 
Ag = 10^(-4); 
Rp = 0.6; 
m = -log(2)/log(cos(Phi1_2));
H0 = Rp*NLEDs*(m+1)/(2*pi)*nc^2*Ag/sin(Psi_Fov);
%-------------------------------------------------------------------------%
Pmax = 0.2;
N0 = 10^(-21); 
B = 10*10^6;
sigman = B*N0; 
%-------------------------------------------------------------------------%
%     APs position for N_r = 16  & dimension = 5x5x3 
%-------------------------------------------------------------------------%
xa = [-1.5 -1.5 -1.5 -1.5 -0.5 -0.5 -0.5 -0.5 0.5 0.5 0.5 0.5 1.5 1.5 1.5 1.5]; 
ya = [-1.5 -0.5 0.5 1.5 -1.5 -0.5 0.5 1.5 -1.5 -0.5 0.5 1.5 -1.5 -0.5 0.5 1.5];
%-------------------------------------------------------------------------%
%     APs position for N_r = 8  & dimension = 5x5x3 
%-------------------------------------------------------------------------%
% xa = [-1.5 -1.5 -0.5 -0.5 0.5 0.5 1.5 1.5];
% ya = [-1.5 1.5 -1.5 1.5 -1.5 1.5 -1.5 1.5];
%-------------------------------------------------------------------------%
%     APs position for N_r = 4  & dimension = 5x5x3 
%-------------------------------------------------------------------------%
% xa = [-1.5 -1.5 1.5 1.5];
% ya = [-1.5 1.5 -1.5 1.5];
%-------------------------------------------------------------------------%
%     APs position for N_r = 16  & dimension = 7x7x3 
%-------------------------------------------------------------------------%
% xa = [-2.1 -2.1 -2.1 -2.1 -0.7 -0.7 -0.7 -0.7 0.7 0.7 0.7 0.7 2.1 2.1 2.1 2.1];
% ya = [-2.1 -0.7 0.7 2.1 -2.1 -0.7 0.7 2.1 -2.1 -0.7 0.7 2.1 -2.1 -0.7 0.7 2.1];
%-------------------------------------------------------------------------%
%     APs position for N_r = 16  & dimension = 9x9x3 
%-------------------------------------------------------------------------%
% xa = [-2.7 -2.7 -2.7 -2.7 -0.9 -0.9 -0.9 -0.9 0.9 0.9 0.9 0.9 2.7 2.7 2.7 2.7];
% ya = [-2.7 -0.9 0.9 2.7 -2.7 -0.9 0.9 2.7 -2.7 -0.9 0.9 2.7 -2.7 -0.9 0.9 2.7];
%-------------------------------------------------------------------------%
za = repmat(ha,[1,N_r]);
%-------------------------------------------------------------------------%
sigma_alpha = 3.67*pi/180;
mu_beta = 40.78*pi/180;
sigma_beta = 2.39*pi/180;
mu_gamma = -0.84*pi/180; 
sigma_gamma = 2.21*pi/180; 
%-------------------------------------------------------------------------%
RSS_total = zeros(N,N_r); 
RSS_LOS = zeros(N,N_r);
Position = zeros(N,3); 
Orientation = zeros(N,3);
Power = zeros(N_,1); 
%-------------------------------------------------------------------------%
tic
parfor nn = 1:1:N
    Iteration = iter1(nn);
    %---------------------------------------------------------------------%
    dimension = [L;W;ha];
    %---------------------------------------------------------------------%
    l = 0; 
    while(l==0)
        posax = xa;
        posay = ya;
        posaz = za;
        %---------------------------------------------------------------------%
        posux = 2*L*rand(1) - L;
        posuy = 2*W*rand(1) - W;
        posuz = h_device*rand(1);
        UE_position = [posux;posuy;posuz];
        omega = 2*pi*rand(1);
        %---------------------------------------------------------------------%
        mu_alpha = omega-pi/2; 
        alpha0 = laprnd(mu_alpha,sigma_alpha,1,1);
        alpha = 1/2*(1-sign(alpha0))*(2*pi-abs(alpha0)) + 1/2*(1+sign(alpha0))*alpha0;
        beta = laprnd(mu_beta,sigma_beta,1,1);
        gamma = laprnd(mu_gamma,sigma_gamma,1,1);
        UE_orientation = [alpha;beta;gamma];
        %---------------------------------------------------------------------%
        H_total = zeros(1,N_r);
        H_LOS = zeros(1,N_r);
        H_NLOS = zeros(1,N_r);
        %---------------------------------------------------------------------%
        for i = 1:1:N_r
            PD_position = [posax(i);posay(i);posaz(i)];
            %---------------------------------------------------------------------%
            H_LOS(i) = LOS_channel_gain_Single_LED(UE_position,UE_orientation,PD_position,Psi_Fov,Phi_Fov,H0,m); 
            H_NLOS(i) = NLOS_channel_gain_Single_LED(UE_position,UE_orientation,PD_position,dimension,Psi_Fov,Phi_Fov,rho,H0,m);
            H_total(i) = H_LOS(i) + H_NLOS(i);
            %---------------------------------------------------------------------%     
        end
        if(length(find(H_LOS>0))>=1)
            l = 1;
        end 
    end
    %---------------------------------------------------------------------%
    Popt = rand(1)*Pmax; 
    noise = normrnd(0,sigman);
    %---------------------------------------------------------------------%
    RSS_total(nn,:) = 10*log10((Popt*H_total).^2/sigman);
    RSS_LOS(nn,:) = 10*log10((Popt*H_LOS).^2/sigman);
    %---------------------------------------------------------------------%
    Position(nn,:) = [posux,posuy,posuz];
    Orientation(nn,:) = [alpha,beta,gamma];
    Power(nn) = Popt; 
    %---------------------------------------------------------------------%
end
toc
RSS_LOS(RSS_LOS==-Inf) = -300;
RSS_total(RSS_total==-Inf) = -300;
%---------------------------------------------------------------------%
Label = [Position,Orientation];
%---------------------------------------------------------------------%